"Work Item Type","Title","Description","State","Priority","Story Points","Tags","Parent","Acceptance Criteria","AI Prompt"
"Epic","Mobile-Friendly Web Application (m.caskr.co)","Develop a mobile-optimized web application accessible at m.caskr.co that provides warehouse staff and field operators with touch-friendly interfaces for core Caskr operations. This replaces the need for native iOS/Android apps by leveraging Progressive Web App (PWA) technology and responsive design. The mobile web app will support barrel scanning via device camera, task management, inventory operations, and offline capabilities.

Business Value:
- Eliminates app store approval delays
- Single codebase reduces maintenance costs by 60%
- Instant updates without user app store downloads
- Works on any device with a modern browser
- Estimated cost savings: $50K-$75K vs native development

Success Metrics:
- Mobile user adoption: 80% of warehouse staff within 30 days
- Task completion time: <30 seconds for common operations
- Offline reliability: 99% sync success rate
- Page load time: <3 seconds on 3G networks","New","1","40","mobile;pwa;responsive;p1-critical","","",""
"Feature","Mobile Detection and Routing","Implement automatic detection of mobile devices and routing to the mobile-optimized experience at m.caskr.co. Desktop users accessing m.caskr.co should be redirected to the main application, and mobile users on the main site should be prompted or redirected to the mobile experience.","New","1","8","mobile;routing;infrastructure","Mobile-Friendly Web Application (m.caskr.co)","- Mobile devices are automatically detected using user agent and screen size
- Mobile users on caskr.co see a prompt to switch to m.caskr.co
- Desktop users on m.caskr.co are redirected to caskr.co
- User preference to stay on desktop/mobile version is remembered
- Deep linking preserves the intended destination page",""
"Task","Create Mobile Detection Service","Implement a service to detect mobile devices and manage routing logic between caskr.co and m.caskr.co","New","1","2","mobile;backend;routing","Mobile Detection and Routing","","You are working on the Caskr distillery management application. Your task is to create a comprehensive mobile detection service that will be used to route users between the main application (caskr.co) and the mobile-optimized version (m.caskr.co).

CONTEXT:
Caskr is a distillery management platform built with ASP.NET Core backend and React TypeScript frontend. The application needs to support warehouse staff who primarily use mobile devices for barrel scanning, task completion, and inventory management. We are implementing a mobile-friendly web app instead of native apps to reduce development costs and maintenance overhead.

REQUIREMENTS:

1. Backend Service (C# ASP.NET Core):
Create a new service at Caskr.Server/Services/MobileDetectionService.cs that:
- Detects mobile devices using User-Agent parsing (support iOS Safari, Android Chrome, and other major mobile browsers)
- Provides screen size detection hints via client-side reporting
- Manages user preferences for site version (stored in database and/or cookies)
- Exposes an API endpoint for the frontend to query device detection results
- Handles edge cases: tablets (should go to mobile), desktop browsers in mobile emulation mode, bots/crawlers

2. Database Schema:
Create a migration to add user_site_preferences table with columns:
- id (bigserial primary key)
- user_id (foreign key to users, nullable for anonymous)
- session_id (varchar for anonymous users)
- preferred_site (enum: 'auto', 'desktop', 'mobile')
- last_detected_device (varchar)
- created_at, updated_at timestamps

3. API Endpoints:
Create a new controller at Caskr.Server/Controllers/MobileDetectionController.cs with:
- GET /api/mobile/detect - Returns device detection result and recommended site
- POST /api/mobile/preference - Saves user's site preference
- GET /api/mobile/preference - Gets current user's preference

4. Frontend Integration:
Create a React hook at caskr.client/src/hooks/useMobileDetection.ts that:
- Calls the detection API on app load
- Provides device type, screen dimensions, and recommended site
- Manages preference storage and retrieval
- Handles redirect logic with appropriate delays for user experience

TECHNICAL SPECIFICATIONS:
- User-Agent detection should use a well-maintained regex pattern library
- Support detection of: iPhone, iPad, Android phones, Android tablets, Windows phones
- Screen breakpoint for mobile: width < 768px
- Include feature detection for touch capability
- Cache detection results for session duration to avoid repeated API calls

TESTING REQUIREMENTS:
You MUST create comprehensive unit tests for all new code. Create test files at:
- Caskr.Server.Tests/Services/MobileDetectionServiceTests.cs
- caskr.client/src/hooks/useMobileDetection.test.ts

Backend tests must cover:
- Successful detection of various mobile User-Agent strings (at least 10 different devices)
- Successful detection of desktop User-Agent strings (Chrome, Firefox, Safari, Edge)
- Tablet detection (iPad, Android tablets)
- Bot/crawler detection and handling
- Preference saving and retrieval for authenticated users
- Preference saving and retrieval for anonymous users (session-based)
- Edge cases: empty User-Agent, malformed User-Agent, very long User-Agent strings
- Database migration rollback testing

Frontend tests must cover:
- Hook initialization and API call on mount
- Correct device type determination
- Preference persistence in localStorage as fallback
- Redirect logic triggering at appropriate times
- Error handling when API is unavailable
- Mock different screen sizes and verify breakpoint logic

FAILURE SCENARIOS TO TEST:
- API timeout (should fall back to client-side detection)
- Database unavailable (should still detect, just not persist preference)
- Invalid preference values submitted
- Concurrent preference updates from multiple tabs
- Network errors during detection

IMPLEMENTATION NOTES:
- Follow existing code patterns in Caskr.Server/Services/ for service structure
- Use dependency injection for all services
- Include XML documentation comments on all public methods
- Log detection results at Debug level for troubleshooting
- Log errors at Error level with full exception details
- Ensure GDPR compliance - device detection data is not PII but preferences may be linked to users

DELIVERABLES:
1. MobileDetectionService.cs with full implementation
2. MobileDetectionController.cs with all endpoints
3. Database migration file for user_site_preferences
4. useMobileDetection.ts React hook
5. Complete test suites for both backend and frontend
6. Update to Caskr.Server/Program.cs to register new services

Begin by analyzing the existing codebase structure, then implement the solution following these specifications exactly."
"Task","Implement Mobile Redirect Middleware","Create ASP.NET Core middleware that handles automatic redirects between desktop and mobile sites based on device detection","New","1","2","mobile;backend;middleware","Mobile Detection and Routing","","You are working on the Caskr distillery management application. Your task is to implement ASP.NET Core middleware that automatically redirects users between the desktop site (caskr.co) and mobile site (m.caskr.co) based on device detection.

CONTEXT:
Caskr has implemented a MobileDetectionService that can identify mobile devices. Now we need middleware that intercepts requests and redirects users to the appropriate site version. This middleware must be intelligent about when to redirect, respect user preferences, and handle edge cases gracefully.

REQUIREMENTS:

1. Middleware Implementation:
Create Caskr.Server/Middleware/MobileRedirectMiddleware.cs that:
- Intercepts all incoming HTTP requests before they reach controllers
- Uses MobileDetectionService to determine device type
- Redirects mobile users on caskr.co to m.caskr.co (and vice versa for desktop)
- Preserves the full URL path and query string during redirect
- Respects user's explicit site preference (no redirect if user chose to stay)
- Skips redirect for API calls (paths starting with /api/)
- Skips redirect for static assets (.js, .css, .png, .jpg, .svg, .woff, etc.)
- Skips redirect for health check endpoints
- Skips redirect for authentication callbacks (OAuth flows)
- Includes a bypass parameter (?nomobile=1 or ?nodesktop=1) for testing

2. Configuration:
Create configuration class Caskr.Server/Configuration/MobileRedirectOptions.cs with:
- Enabled (bool) - Master switch to enable/disable redirects
- MobileDomain (string) - The mobile site domain (m.caskr.co)
- DesktopDomain (string) - The desktop site domain (caskr.co)
- ExcludedPaths (List<string>) - Paths to never redirect
- ExcludedExtensions (List<string>) - File extensions to skip
- PreferenceOverrideParameter (string) - Query param to bypass redirect
- RedirectStatusCode (int) - 301 permanent or 302 temporary (default 302)

Add configuration section to appsettings.json:
```json
{
  ""MobileRedirect"": {
    ""Enabled"": true,
    ""MobileDomain"": ""m.caskr.co"",
    ""DesktopDomain"": ""caskr.co"",
    ""ExcludedPaths"": [""/api/"", ""/health"", ""/signin-oidc"", ""/signout-callback-oidc""],
    ""ExcludedExtensions"": ["".js"", "".css"", "".png"", "".jpg"", "".gif"", "".svg"", "".ico"", "".woff"", "".woff2""],
    ""PreferenceOverrideParameter"": ""stayonsite"",
    ""RedirectStatusCode"": 302
  }
}
```

3. Middleware Extension:
Create extension method in Caskr.Server/Middleware/MobileRedirectMiddlewareExtensions.cs:
- UseMobileRedirect(this IApplicationBuilder app) for easy registration
- AddMobileRedirect(this IServiceCollection services, IConfiguration config) for DI setup

4. Request Flow Logic:
```
Request arrives
  -> Is path excluded? Skip redirect
  -> Is extension excluded? Skip redirect
  -> Has bypass parameter? Skip redirect and set preference cookie
  -> Check user preference (cookie/database)
     -> User prefers current site? Skip redirect
  -> Detect device type
     -> Mobile on desktop domain? Redirect to mobile
     -> Desktop on mobile domain? Redirect to desktop
  -> Preserve path and query string in redirect URL
  -> Return redirect response
```

5. Logging:
- Log redirect decisions at Information level (from domain, to domain, reason)
- Log skipped redirects at Debug level
- Log configuration load at startup
- Include correlation ID in all logs for request tracing

TECHNICAL SPECIFICATIONS:
- Middleware must be registered early in pipeline (before MVC routing)
- Use IOptions<MobileRedirectOptions> pattern for configuration
- Support both cookie-based and header-based preference storage
- Set appropriate cache headers on redirect responses (no-cache for 302)
- Handle HTTPS properly - always redirect to HTTPS on production
- Support localhost development (detect via Host header)

TESTING REQUIREMENTS:
Create comprehensive tests at Caskr.Server.Tests/Middleware/MobileRedirectMiddlewareTests.cs

SUCCESS SCENARIO TESTS:
- Mobile User-Agent on desktop domain redirects to mobile domain with same path
- Desktop User-Agent on mobile domain redirects to desktop domain with same path
- Query parameters are preserved during redirect (test with complex query strings)
- Fragment identifiers handled appropriately
- HTTPS scheme is preserved
- Redirect includes proper Location header
- Response status code matches configuration

SKIP REDIRECT TESTS:
- API paths (/api/anything) are never redirected
- Static file extensions are never redirected
- Health check endpoint is never redirected
- OAuth callback paths are never redirected
- User with 'desktop' preference on mobile domain is not redirected
- User with 'mobile' preference on desktop domain is not redirected
- Bypass parameter prevents redirect and sets preference

FAILURE SCENARIO TESTS:
- MobileDetectionService throws exception - middleware should not redirect, log error, continue pipeline
- Invalid configuration (null domains) - should throw at startup with clear message
- Malformed URL in request - should handle gracefully without crash
- Missing Host header - should handle gracefully
- Configuration disabled - no redirects occur

EDGE CASE TESTS:
- Request to root path (/) redirects correctly
- Request with URL-encoded characters in path
- Request with international characters in query string
- Very long URLs (>2000 characters)
- Requests from load balancer with X-Forwarded-Host header
- Requests behind reverse proxy with X-Original-URL header

INTEGRATION TESTS:
Create Caskr.Server.Tests/Integration/MobileRedirectIntegrationTests.cs using WebApplicationFactory:
- Full request/response cycle testing
- Cookie persistence across requests
- Preference change mid-session

PERFORMANCE TESTS:
- Middleware execution time should be <1ms for skip decisions
- Middleware execution time should be <5ms for redirect decisions
- No memory leaks with sustained traffic

DELIVERABLES:
1. MobileRedirectMiddleware.cs with complete implementation
2. MobileRedirectOptions.cs configuration class
3. MobileRedirectMiddlewareExtensions.cs for easy registration
4. Updated appsettings.json with MobileRedirect section
5. Updated Program.cs to register middleware and configuration
6. Complete unit test suite
7. Integration test suite
8. XML documentation on all public members

Analyze the existing middleware patterns in the Caskr codebase before implementing. Follow the established conventions for middleware registration and configuration."
"Task","Create Mobile Site Switch UI Component","Implement a React component that allows users to switch between desktop and mobile site versions with preference persistence","New","1","1","mobile;frontend;react","Mobile Detection and Routing","","You are working on the Caskr distillery management application. Your task is to create a React component that provides users with the ability to switch between the desktop and mobile site versions, with their preference being persisted.

CONTEXT:
Caskr is implementing automatic mobile detection and redirects between caskr.co and m.caskr.co. However, users must have the ability to override automatic detection and choose their preferred site version. This component will appear on both sites and allow users to switch or confirm their preference.

REQUIREMENTS:

1. Main Component:
Create caskr.client/src/components/SiteSwitcher/SiteSwitcher.tsx that:
- Displays current site version (Desktop/Mobile)
- Shows a toggle or button to switch to the other version
- Displays device detection result (""We detected you're on a mobile device"")
- Includes ""Remember my choice"" checkbox
- Has smooth animations for state changes
- Is accessible (ARIA labels, keyboard navigation, screen reader support)
- Supports dark mode (if applicable to Caskr's design system)

2. Component Variants:
Create multiple presentation variants:
- Banner variant: Full-width banner at top/bottom of page for first-time visitors
- Compact variant: Small icon/link in header or footer for subsequent visits
- Modal variant: Popup dialog for explicit preference setting
- Toast variant: Non-intrusive notification with switch option

3. Sub-components:
Create supporting components in caskr.client/src/components/SiteSwitcher/:
- SiteSwitcherBanner.tsx - Full-width promotional banner
- SiteSwitcherToggle.tsx - Simple toggle switch
- SiteSwitcherModal.tsx - Modal dialog for preferences
- SiteSwitcherContext.tsx - Context provider for site preference state
- useSiteSwitcher.ts - Custom hook for site switching logic

4. Styling:
Create caskr.client/src/components/SiteSwitcher/SiteSwitcher.module.css (or styled-components if that's the project convention):
- Mobile-first responsive design
- Touch-friendly tap targets (minimum 44x44px)
- Clear visual distinction between current and available site
- Smooth transitions (0.2s ease-in-out)
- Support for reduced-motion preference

5. Integration with Backend:
The component must:
- Call POST /api/mobile/preference when user makes a choice
- Handle API errors gracefully with retry logic
- Fall back to localStorage if API is unavailable
- Sync preference across tabs using storage events
- Clear preference when user logs out

6. State Management:
Using the existing state management pattern (Redux or Context):
- Store current site preference
- Store whether user has been prompted
- Store detection result from backend
- Provide actions for updating preference

7. Banner Display Logic:
- Show banner only on first visit (check localStorage/cookie)
- Show banner if device type doesn't match current site
- Don't show banner if user has already set a preference
- Allow banner to be dismissed (remember dismissal for 7 days)
- Show banner again if user switches devices

TECHNICAL SPECIFICATIONS:
- Use TypeScript with strict mode
- Component must be fully typed with proper interfaces
- Use React.memo for performance optimization where appropriate
- Lazy load modal variant to reduce initial bundle size
- Support SSR (no window/document access on server)
- Bundle size target: <10KB gzipped for main component

COMPONENT API:
```typescript
interface SiteSwitcherProps {
  variant: 'banner' | 'compact' | 'modal' | 'toast';
  position?: 'top' | 'bottom'; // for banner variant
  onSwitch?: (newSite: 'desktop' | 'mobile') => void;
  onDismiss?: () => void;
  showRememberOption?: boolean;
  autoRedirect?: boolean; // redirect immediately on switch
  redirectDelay?: number; // ms to wait before redirect
  className?: string;
  testId?: string; // for e2e testing
}

interface SiteSwitcherContextValue {
  currentSite: 'desktop' | 'mobile';
  detectedDevice: 'desktop' | 'mobile' | 'tablet' | 'unknown';
  preference: 'auto' | 'desktop' | 'mobile';
  hasBeenPrompted: boolean;
  isLoading: boolean;
  error: Error | null;
  setPreference: (pref: 'auto' | 'desktop' | 'mobile') => Promise<void>;
  dismissPrompt: () => void;
  switchSite: () => void;
}
```

TESTING REQUIREMENTS:
Create comprehensive tests at caskr.client/src/components/SiteSwitcher/__tests__/:

UNIT TESTS (SiteSwitcher.test.tsx):
- Renders correctly in each variant
- Displays correct current site
- Displays correct detected device
- Toggle/button click calls onSwitch callback
- Remember checkbox updates preference persistence
- Dismiss button calls onDismiss and hides component
- Loading state displays spinner/skeleton
- Error state displays error message with retry button
- Keyboard navigation works (Tab, Enter, Space)
- ARIA attributes are correct

HOOK TESTS (useSiteSwitcher.test.ts):
- Returns correct initial state
- Calls API on preference change
- Falls back to localStorage on API error
- Syncs across tabs via storage events
- Clears preference on logout event
- Handles race conditions in rapid preference changes

INTEGRATION TESTS:
- Full flow: detect device -> show banner -> user clicks switch -> API called -> redirect occurs
- Full flow: user dismisses banner -> banner hidden -> preference saved -> banner not shown on refresh
- Error flow: API fails -> localStorage fallback -> preference still works

ACCESSIBILITY TESTS:
- Component passes axe-core automated checks
- Focus management is correct when modal opens/closes
- Screen reader announces state changes
- Color contrast meets WCAG 2.1 AA standards

VISUAL REGRESSION TESTS:
- Snapshot tests for each variant
- Snapshot tests for dark mode (if applicable)
- Snapshot tests for mobile viewport
- Snapshot tests for loading/error states

MOCK SETUP:
- Mock useMobileDetection hook
- Mock API calls with MSW or jest mocks
- Mock localStorage
- Mock window.location for redirect testing

DELIVERABLES:
1. All component files in caskr.client/src/components/SiteSwitcher/
2. Complete test suite with >90% coverage
3. Storybook stories for each variant (if Storybook is used)
4. Integration into main layout component (show where to add SiteSwitcher)
5. Documentation in component file header explaining usage

Follow the existing component patterns in the Caskr codebase. Check caskr.client/src/components/ for styling conventions, state management patterns, and testing approaches before implementing."
"Feature","Mobile-Optimized Core Pages","Redesign and implement mobile-optimized versions of core Caskr pages for the m.caskr.co domain. These pages should be touch-friendly, load quickly on mobile networks, and support the primary workflows warehouse staff need: barrel lookup, task management, and inventory operations.","New","1","13","mobile;frontend;responsive","Mobile-Friendly Web Application (m.caskr.co)","- Dashboard loads in <3 seconds on 3G
- All touch targets are minimum 44x44px
- Forms are optimized for mobile input (proper keyboard types)
- Navigation is thumb-friendly (bottom nav or hamburger)
- Critical actions require maximum 3 taps
- Pages work in portrait and landscape orientations
- Pull-to-refresh is implemented where appropriate",""
"Task","Create Mobile Application Shell and Navigation","Implement the mobile app shell with bottom navigation, header, and overall layout structure for m.caskr.co","New","1","3","mobile;frontend;navigation","Mobile-Optimized Core Pages","","You are working on the Caskr distillery management application. Your task is to create the mobile application shell and navigation structure for the mobile-optimized site at m.caskr.co.

CONTEXT:
Caskr is building a mobile-friendly web application for warehouse staff who need quick access to barrel management, task completion, and inventory operations. The mobile app needs a fundamentally different navigation pattern than the desktop application - optimized for one-handed use, thumb reachability, and quick task completion.

CURRENT DESKTOP NAVIGATION:
The desktop app uses a horizontal top navigation with: Dashboard | Orders | Barrels | TTB Compliance | Products | Reports | Report Builder | Accounting | Sync History

MOBILE NAVIGATION REQUIREMENTS:
For mobile, we need a bottom navigation pattern with the most critical actions, plus a hamburger menu for less frequent operations.

REQUIREMENTS:

1. Mobile App Shell:
Create caskr.client/src/mobile/MobileAppShell.tsx that provides:
- Fixed bottom navigation bar with 4-5 primary actions
- Collapsible header with page title and action buttons
- Main content area with safe area insets for notched phones
- Slide-out drawer menu for secondary navigation
- Toast/snackbar area for notifications
- Loading overlay for page transitions

2. Bottom Navigation:
Create caskr.client/src/mobile/components/BottomNav/BottomNav.tsx:
Primary tabs (always visible):
- Home (Dashboard icon) - Quick stats and recent activity
- Scan (Camera/QR icon) - Barrel scanning (most important action)
- Tasks (Checklist icon) - Today's tasks with badge count
- Barrels (Barrel icon) - Barrel search and lookup
- More (Hamburger icon) - Opens drawer with all other options

Requirements:
- Icons with labels below (not icon-only)
- Active state clearly distinguished (color + slight scale)
- Badge support for notifications (e.g., ""3"" on Tasks)
- Haptic feedback on tap (if supported)
- Safe area padding for devices with home indicators
- Height: 56-64px depending on safe area

3. Mobile Header:
Create caskr.client/src/mobile/components/MobileHeader/MobileHeader.tsx:
- Page title (large, prominent)
- Optional subtitle or breadcrumb
- Left action slot (back button or menu)
- Right action slot (1-2 contextual actions)
- Collapses on scroll (title moves inline, reduces height)
- Pull-to-refresh indicator integration point

4. Drawer Menu:
Create caskr.client/src/mobile/components/DrawerMenu/DrawerMenu.tsx:
- User profile section at top (avatar, name, company)
- Navigation sections grouped logically:
  - Operations: Dashboard, Orders, Barrels, Tasks
  - Compliance: TTB Reports, Gauge Records, Audit Trail
  - Reports: Standard Reports, Custom Reports
  - Settings: Account, Sync Status, Preferences, Logout
- Swipe-to-close gesture support
- Backdrop overlay with tap-to-close
- Smooth slide animation (transform, not left/right positioning)

5. Mobile Router Setup:
Create caskr.client/src/mobile/MobileRouter.tsx:
- Define mobile-specific routes
- Lazy load page components for performance
- Handle deep linking from desktop redirects
- Preserve scroll position on back navigation
- Page transition animations (slide left/right)

6. Responsive Utilities:
Create caskr.client/src/mobile/utils/responsive.ts:
- useSafeArea() hook - returns inset values for notched devices
- useBottomNavHeight() hook - returns nav height for content padding
- useHeaderCollapse() hook - manages header collapse on scroll
- useDrawer() hook - manages drawer open/close state
- useHaptics() hook - provides haptic feedback helpers

TECHNICAL SPECIFICATIONS:
- Use CSS custom properties for safe area insets: env(safe-area-inset-bottom)
- Bottom nav z-index: 1000
- Drawer z-index: 1100
- Header z-index: 900
- Use position: fixed for nav elements, not sticky
- Prevent body scroll when drawer is open
- Support iOS rubber-band scrolling feel
- Use transform3d for GPU-accelerated animations
- Respect prefers-reduced-motion media query

FILE STRUCTURE:
```
caskr.client/src/mobile/
├── MobileAppShell.tsx
├── MobileRouter.tsx
├── components/
│   ├── BottomNav/
│   │   ├── BottomNav.tsx
│   │   ├── BottomNav.module.css
│   │   ├── BottomNavItem.tsx
│   │   └── index.ts
│   ├── MobileHeader/
│   │   ├── MobileHeader.tsx
│   │   ├── MobileHeader.module.css
│   │   └── index.ts
│   ├── DrawerMenu/
│   │   ├── DrawerMenu.tsx
│   │   ├── DrawerMenu.module.css
│   │   ├── DrawerMenuItem.tsx
│   │   └── index.ts
│   └── common/
│       ├── TouchRipple.tsx
│       ├── SwipeHandler.tsx
│       └── index.ts
├── hooks/
│   ├── useSafeArea.ts
│   ├── useBottomNavHeight.ts
│   ├── useHeaderCollapse.ts
│   ├── useDrawer.ts
│   └── useHaptics.ts
├── utils/
│   └── responsive.ts
└── styles/
    └── mobile-base.css
```

TESTING REQUIREMENTS:
Create tests in caskr.client/src/mobile/__tests__/:

UNIT TESTS:
- BottomNav renders all navigation items
- BottomNav highlights active route correctly
- BottomNav badge displays correct count
- BottomNav calls navigation handler on tap
- MobileHeader displays title and actions
- MobileHeader collapses on scroll event
- MobileHeader back button triggers navigation
- DrawerMenu opens and closes correctly
- DrawerMenu renders all menu sections
- DrawerMenu closes on backdrop tap
- DrawerMenu closes on swipe gesture
- DrawerMenu closes on menu item tap

HOOK TESTS:
- useSafeArea returns correct insets (mock CSS env variables)
- useHeaderCollapse responds to scroll position
- useDrawer manages open/close state correctly
- useHaptics gracefully handles unsupported browsers

INTEGRATION TESTS:
- Full navigation flow: tap bottom nav -> page loads -> header updates
- Drawer flow: tap More -> drawer opens -> tap item -> drawer closes -> page loads
- Deep link handling: external URL loads correct page with navigation state
- Back navigation: navigate forward -> tap back -> previous page with scroll position

GESTURE TESTS:
- Swipe right on drawer opens it
- Swipe left on open drawer closes it
- Swipe down on header triggers pull-to-refresh (if implemented)

ACCESSIBILITY TESTS:
- All navigation elements have proper ARIA roles
- Focus trap works correctly in open drawer
- Screen reader announces navigation changes
- Reduced motion respects user preference

VISUAL/SNAPSHOT TESTS:
- Bottom nav in default state
- Bottom nav with active item
- Bottom nav with badges
- Header expanded and collapsed
- Drawer open state
- Drawer closed state

PERFORMANCE TESTS:
- Navigation tap to page visible: <100ms
- Drawer open animation: 60fps
- Header collapse animation: 60fps
- No layout thrashing during scroll

DELIVERABLES:
1. Complete mobile shell implementation
2. All component files with TypeScript types
3. CSS modules for all components
4. Custom hooks for responsive utilities
5. Full test suite
6. Integration with existing auth context
7. Update to main app entry point to use MobileRouter when on mobile domain

Review the existing desktop navigation in caskr.client/src/components/ to understand the current patterns, then create the mobile-specific implementation following these specifications."
"Task","Implement Mobile Dashboard Page","Create a mobile-optimized dashboard page showing key metrics, recent activity, and quick actions for warehouse staff","New","1","2","mobile;frontend;dashboard","Mobile-Optimized Core Pages","","You are working on the Caskr distillery management application. Your task is to implement a mobile-optimized dashboard page for the m.caskr.co mobile web application.

CONTEXT:
The desktop Caskr dashboard shows order progress, outstanding tasks, and compliance status. The mobile dashboard needs to present this same information in a format optimized for quick glances and immediate action. Warehouse staff check this page multiple times per day to see what needs their attention.

CURRENT DESKTOP DASHBOARD:
Located at caskr.client/src/pages/Dashboard.tsx, it displays:
- Order progress cards with percentage completion
- Outstanding tasks list
- Monthly compliance status
- Quick links to common actions

MOBILE DASHBOARD REQUIREMENTS:
The mobile dashboard must prioritize actionable information and minimize scrolling to see critical data.

REQUIREMENTS:

1. Mobile Dashboard Page:
Create caskr.client/src/mobile/pages/MobileDashboard/MobileDashboard.tsx:

Layout structure (top to bottom):
- Greeting section: ""Good morning, [Name]"" with date
- Alert banner: Any critical compliance or overdue items (red/amber)
- Quick actions row: 4 large tap targets for most common actions
- Today's priorities: Tasks due today with quick-complete buttons
- Active orders: Horizontal scrolling cards showing order progress
- Recent activity: Last 5 actions (collapsible)

2. Quick Actions Component:
Create caskr.client/src/mobile/pages/MobileDashboard/QuickActions.tsx:
- Scan Barrel (opens camera)
- New Task (opens task creation)
- Record Movement (barrel transfer)
- Log Gauge (opens gauge record form)
Each action should be a 80x80px touch target with icon and label

3. Today's Priorities Component:
Create caskr.client/src/mobile/pages/MobileDashboard/TodaysPriorities.tsx:
- List of tasks due today, sorted by priority
- Each task shows: title, assignee, due time, order reference
- Swipe right to complete (with undo toast)
- Tap to expand details
- Empty state: ""All caught up!"" with celebratory icon
- Max 5 items shown, ""View all X tasks"" link for more

4. Active Orders Component:
Create caskr.client/src/mobile/pages/MobileDashboard/ActiveOrders.tsx:
- Horizontal scrolling carousel of order cards
- Each card shows: order name, progress percentage, circular progress indicator, barrel count
- Tap card to navigate to order details
- Shows up to 10 active orders
- Empty state when no active orders

5. Alert Banner Component:
Create caskr.client/src/mobile/pages/MobileDashboard/AlertBanner.tsx:
Types of alerts (priority order):
- Critical: TTB report due today (red)
- Warning: Tasks overdue (amber)
- Info: Sync status issues (blue)
Behavior:
- Tappable to navigate to relevant page
- Dismissible (but reappears on refresh if condition persists)
- Multiple alerts stack vertically

6. Pull-to-Refresh:
Implement pull-to-refresh that:
- Refreshes all dashboard data
- Shows spinner during refresh
- Provides haptic feedback on trigger
- Animates smoothly (elastic pull effect)

7. Data Fetching:
Create caskr.client/src/mobile/pages/MobileDashboard/useDashboardData.ts:
- Fetch tasks, orders, alerts in parallel
- Cache data with SWR or React Query pattern
- Background refresh every 60 seconds when page is visible
- Show stale data immediately, refresh in background
- Handle offline gracefully (show cached data with ""offline"" indicator)

TECHNICAL SPECIFICATIONS:
- Page must render meaningful content within 1 second
- Above-the-fold content must not require scrolling on iPhone SE size (375px wide)
- Use skeleton loaders for initial load, not spinners
- Implement intersection observer for lazy loading below-fold content
- Horizontal scroll areas should have momentum scrolling (-webkit-overflow-scrolling: touch)
- Progress circles should animate on first render

API ENDPOINTS USED:
- GET /api/tasks?status=pending&assignee=me&dueDate=today (or adapt existing)
- GET /api/orders?status=active&limit=10
- GET /api/dashboard/alerts (may need to create this)
- GET /api/ttb/compliance-status

COMPONENT STYLING:
- Use CSS custom properties for consistent spacing
- Touch targets minimum 44x44px
- Cards should have subtle shadows for depth
- Use system font stack for fastest rendering
- Progress indicators should use brand colors
- Support dark mode if design system includes it

TESTING REQUIREMENTS:
Create tests in caskr.client/src/mobile/pages/MobileDashboard/__tests__/:

UNIT TESTS:
- MobileDashboard renders greeting with correct time of day
- MobileDashboard shows alert banner when alerts exist
- MobileDashboard hides alert banner when no alerts
- QuickActions renders all 4 action buttons
- QuickActions navigates correctly on tap
- TodaysPriorities renders task list
- TodaysPriorities handles swipe-to-complete
- TodaysPriorities shows undo toast after complete
- TodaysPriorities shows empty state when no tasks
- ActiveOrders renders order cards in carousel
- ActiveOrders navigates to order on tap
- ActiveOrders shows empty state when no orders
- AlertBanner renders correct alert type styling
- AlertBanner dismisses on tap (X button)

DATA HOOK TESTS:
- useDashboardData fetches all data on mount
- useDashboardData returns loading state initially
- useDashboardData returns cached data on subsequent renders
- useDashboardData handles API errors gracefully
- useDashboardData refreshes when pull-to-refresh triggered
- useDashboardData refetches on interval when visible
- useDashboardData pauses refetch when page not visible

INTEGRATION TESTS:
- Full page load with all components rendering
- Pull-to-refresh flow: pull -> spinner -> data refreshes
- Task completion flow: swipe -> task removed -> undo toast -> tap undo -> task restored
- Navigation flow: tap order card -> order page loads
- Offline flow: disconnect network -> page shows cached data with indicator

ERROR HANDLING TESTS:
- API returns 500 -> error message displayed with retry button
- API returns empty data -> empty states shown correctly
- Network timeout -> loading doesn't hang forever
- Partial API failure (one endpoint fails) -> other data still displays

ACCESSIBILITY TESTS:
- Page passes axe-core checks
- All interactive elements are focusable
- Screen reader announces dynamic content changes
- Touch targets meet minimum size requirements

PERFORMANCE TESTS:
- First contentful paint <1s on fast 3G
- Time to interactive <3s on fast 3G
- No layout shift after initial render
- Smooth scrolling at 60fps

SNAPSHOT TESTS:
- Dashboard with full data
- Dashboard with empty states
- Dashboard with alert banner
- Dashboard in loading state
- Dashboard in error state
- Dashboard in offline mode

DELIVERABLES:
1. All component files in MobileDashboard folder
2. useDashboardData hook with caching logic
3. Complete test suite with >85% coverage
4. Integration with mobile router
5. Any new API endpoints needed (with backend implementation)
6. TypeScript interfaces for all data types

Review the existing desktop Dashboard.tsx and the API endpoints it uses, then create the mobile-optimized version following these specifications."
"Task","Implement Mobile Barrel Lookup Page","Create a mobile-optimized barrel search and details page with camera-based scanning capability","New","1","3","mobile;frontend;barrels;camera","Mobile-Optimized Core Pages","","You are working on the Caskr distillery management application. Your task is to implement a mobile-optimized barrel lookup page with integrated camera scanning for the m.caskr.co mobile web application.

CONTEXT:
Barrel lookup is one of the most frequent operations for warehouse staff. They need to quickly find a barrel by scanning its barcode/QR code or searching by SKU, then view its details and perform actions like recording movements or gauge readings. The mobile experience must be faster than looking up a barrel on paper or the desktop app.

REQUIREMENTS:

1. Mobile Barrel Page:
Create caskr.client/src/mobile/pages/MobileBarrels/MobileBarrels.tsx:

Main view with two modes:
- Scan mode (default): Camera viewfinder with scan button
- Search mode: Text search with filters

Layout:
- Top: Toggle between Scan/Search modes
- Middle: Camera viewfinder OR search input + results
- Bottom: Recent barrels (last 5 viewed)

2. Camera Scanner Component:
Create caskr.client/src/mobile/components/BarcodeScanner/BarcodeScanner.tsx:
- Uses device camera via getUserMedia API
- Supports QR codes and Code128 barcodes (standard barrel labels)
- Real-time scanning with visual feedback
- Torch/flashlight toggle for dark warehouses
- Camera flip (front/back) button
- Viewfinder overlay with scan region highlight
- Haptic + audio feedback on successful scan
- Handles camera permission request gracefully
- Fallback for devices without camera: manual entry prompt

Technical implementation:
- Use @aspect-hq/barcode-scanner or similar library
- Implement as a reusable component for other scanning needs
- Support both continuous scanning and single-shot modes
- Optimize for performance (30fps minimum)

3. Search Interface:
Create caskr.client/src/mobile/pages/MobileBarrels/BarrelSearch.tsx:
- Search input with:
  - Auto-focus on mount
  - Clear button
  - Voice input button (if supported)
  - Search on typing (debounced 300ms)
- Filter chips below input:
  - All, Filled, Empty, In Transit
  - Rickhouse filter (dropdown)
- Results list:
  - Virtual scrolling for long lists
  - Each result shows: SKU, status, rickhouse, age, batch name
  - Tap to view details
- Empty state: ""No barrels found"" with suggestions
- Loading state: Skeleton items

4. Barrel Details Sheet:
Create caskr.client/src/mobile/pages/MobileBarrels/BarrelDetailsSheet.tsx:
- Slides up from bottom (modal sheet pattern)
- Drag to expand/collapse/dismiss
- Can be expanded to full screen

Content sections:
- Header: SKU, status badge, quick action buttons
- Key Info: Fill date, age, current location, batch, spirit type
- Volume: Current proof gallons, original proof gallons, loss %
- History timeline: Recent movements and gauge records
- Actions section (sticky at bottom):
  - Record Movement
  - Record Gauge
  - View Full History
  - Print Label (if supported)

5. Recent Barrels Component:
Create caskr.client/src/mobile/pages/MobileBarrels/RecentBarrels.tsx:
- Horizontal scroll of recently viewed barrels
- Each item shows: SKU, status, location
- Tap to re-open details
- Stored in localStorage (persists across sessions)
- Maximum 10 items, LIFO when full

6. Barrel Actions:
Implement quick action flows accessible from details:

Record Movement:
- Select destination rickhouse
- Optional: add notes
- Confirm and save
- Success feedback with undo option

Record Gauge:
- Enter proof, temperature, volume
- Auto-calculates proof gallons
- TTB compliance validation
- Confirm and save

7. State Management:
Create caskr.client/src/mobile/pages/MobileBarrels/useBarrelLookup.ts:
- Manages scan result handling
- Manages search state and results
- Caches barrel details for offline reference
- Tracks recent barrels
- Handles optimistic updates for actions

TECHNICAL SPECIFICATIONS:

Camera Access:
```typescript
const constraints = {
  video: {
    facingMode: 'environment', // Back camera
    width: { ideal: 1280 },
    height: { ideal: 720 },
    focusMode: 'continuous',
  }
};
```

Barcode Formats:
- QR Code (preferred for new labels)
- Code128 (existing labels)
- Expected format: ""CASKR-{SKU}"" or raw SKU

API Endpoints:
- GET /api/barrels/{sku} - Single barrel details
- GET /api/barrels/search?q={query}&status={status}&rickhouse={id}
- POST /api/barrels/{id}/movements - Record movement
- POST /api/gauge-records - Record gauge reading

Offline Support:
- Cache last 50 barrel lookups in IndexedDB
- Queue movements/gauges when offline
- Sync when connection restored
- Show offline indicator

TESTING REQUIREMENTS:
Create tests in caskr.client/src/mobile/pages/MobileBarrels/__tests__/:

BARCODE SCANNER TESTS:
- BarcodeScanner requests camera permission on mount
- BarcodeScanner handles permission denied gracefully
- BarcodeScanner displays camera feed when permission granted
- BarcodeScanner detects QR code and calls onScan callback
- BarcodeScanner detects Code128 and calls onScan callback
- BarcodeScanner shows torch button only when available
- BarcodeScanner toggles torch on/off
- BarcodeScanner flips camera on button press
- BarcodeScanner plays sound and haptic on successful scan
- BarcodeScanner cleans up camera stream on unmount
- BarcodeScanner handles devices without camera

SEARCH TESTS:
- BarrelSearch shows input focused on mount
- BarrelSearch triggers search after debounce
- BarrelSearch shows loading state during search
- BarrelSearch displays results correctly
- BarrelSearch shows empty state when no results
- BarrelSearch filters by status when chip selected
- BarrelSearch filters by rickhouse when selected
- BarrelSearch clears on clear button tap
- BarrelSearch handles API errors

DETAILS SHEET TESTS:
- BarrelDetailsSheet renders barrel information
- BarrelDetailsSheet shows correct status badge
- BarrelDetailsSheet displays history timeline
- BarrelDetailsSheet expands on drag up
- BarrelDetailsSheet collapses on drag down
- BarrelDetailsSheet dismisses on fast swipe down
- BarrelDetailsSheet action buttons navigate correctly

ACTION TESTS:
- Record Movement form validates destination
- Record Movement saves successfully
- Record Movement shows success feedback
- Record Movement handles API error
- Record Gauge form calculates proof gallons
- Record Gauge validates TTB requirements
- Record Gauge saves successfully
- Record Gauge queues when offline

INTEGRATION TESTS:
- Full flow: open scanner -> scan barrel -> details load -> record movement -> success
- Full flow: search barrel -> tap result -> details load -> record gauge -> success
- Offline flow: scan barrel -> queue movement -> go online -> movement syncs

ACCESSIBILITY TESTS:
- Camera viewfinder has descriptive ARIA label
- Search input is properly labeled
- Results list is navigable by screen reader
- Details sheet announces when opened
- Actions are keyboard accessible

PERFORMANCE TESTS:
- Camera preview starts within 2 seconds
- Barcode detection occurs within 500ms of code entering frame
- Search results render within 300ms of API response
- Details sheet animation runs at 60fps

DELIVERABLES:
1. All component files in MobileBarrels folder
2. BarcodeScanner as reusable component
3. Complete test suite
4. Offline caching implementation
5. Integration with mobile router and navigation
6. Any new API endpoints needed

Review the existing Barrels page at caskr.client/src/pages/Barrels.tsx and the barrel-related API endpoints, then create the mobile-optimized implementation."
"Task","Implement Mobile Task Management Page","Create a mobile-optimized task list and management page with swipe gestures and quick completion","New","1","2","mobile;frontend;tasks","Mobile-Optimized Core Pages","","You are working on the Caskr distillery management application. Your task is to implement a mobile-optimized task management page for warehouse staff to view, complete, and create tasks.

CONTEXT:
Task management is critical for daily warehouse operations. Staff need to see their assigned tasks, mark them complete quickly, and occasionally create new tasks. The mobile experience should feel like a native todo app - fast, responsive, and satisfying to use.

REQUIREMENTS:

1. Mobile Tasks Page:
Create caskr.client/src/mobile/pages/MobileTasks/MobileTasks.tsx:

Layout:
- Header with filter/sort options
- Task count summary (""5 of 12 completed today"")
- Segmented control: My Tasks | All Tasks | Completed
- Task list with swipe actions
- Floating action button (FAB) for new task

2. Task List Component:
Create caskr.client/src/mobile/pages/MobileTasks/TaskList.tsx:
- Virtualized list for performance (react-window or similar)
- Group by: Due date (Overdue, Today, Tomorrow, This Week, Later)
- Each task item shows:
  - Checkbox (tappable to complete)
  - Task title (main text)
  - Order reference (secondary text)
  - Assignee avatar (if viewing All Tasks)
  - Due time/date
  - Priority indicator (color bar on left edge)
- Swipe actions:
  - Swipe right: Complete task (green checkmark reveal)
  - Swipe left: Options menu (Edit, Reassign, Delete)
- Long press: Multi-select mode
- Pull-to-refresh

3. Task Item Component:
Create caskr.client/src/mobile/pages/MobileTasks/TaskItem.tsx:
- Optimized for re-renders (memoized)
- Swipe gesture handling with velocity detection
- Threshold: 40% of width to trigger action
- Spring animation back if not triggered
- Complete animation: shrink and fade out
- Support for reduced motion preference

4. Task Detail Sheet:
Create caskr.client/src/mobile/pages/MobileTasks/TaskDetailSheet.tsx:
- Bottom sheet modal
- Full task details:
  - Title
  - Description
  - Order link (tappable to navigate)
  - Barrel link if applicable
  - Assignee (tappable to change)
  - Due date/time (tappable to change)
  - Priority (tappable to change)
  - Created by and created date
  - Completion status with timestamp if completed
- Action buttons at bottom:
  - Complete / Uncomplete
  - Edit
  - Delete (with confirmation)

5. Create/Edit Task Sheet:
Create caskr.client/src/mobile/pages/MobileTasks/TaskFormSheet.tsx:
- Bottom sheet form
- Fields:
  - Title (required) - text input
  - Description (optional) - multiline text
  - Order (optional) - searchable select
  - Assignee (required) - select from team
  - Due date - date picker
  - Due time (optional) - time picker
  - Priority - segmented control (Low, Normal, High, Urgent)
- Save button (disabled until valid)
- Cancel button with unsaved changes confirmation

6. Filter/Sort Controls:
Create caskr.client/src/mobile/pages/MobileTasks/TaskFilters.tsx:
- Accessible via header button
- Bottom sheet with options:
  - Filter by:
    - Status: All, Pending, Completed
    - Priority: All, Urgent, High, Normal, Low
    - Due: All, Overdue, Due Today, Due This Week
    - Order: Select specific order
  - Sort by:
    - Due date (default)
    - Priority
    - Created date
    - Alphabetical
  - Sort direction: Asc/Desc
- ""Clear filters"" button
- Filter badge on header when filters active

7. Multi-Select Mode:
When activated (long press):
- Checkboxes appear on all items
- Header changes to selection mode:
  - ""X selected"" count
  - Close button to exit mode
  - Action buttons: Complete All, Delete All
- Bottom action bar with bulk actions

8. State Management:
Create caskr.client/src/mobile/pages/MobileTasks/useTasksState.ts:
- Fetch tasks with pagination
- Optimistic updates for completion
- Undo support (5 second window)
- Cache with background refresh
- Offline queue for completions
- Filter/sort state management
- Multi-select state

TECHNICAL SPECIFICATIONS:

Swipe Gesture Math:
```typescript
const SWIPE_THRESHOLD = 0.4; // 40% of item width
const VELOCITY_THRESHOLD = 0.5; // pixels per millisecond

function shouldTriggerAction(translateX: number, velocity: number, itemWidth: number): boolean {
  const threshold = itemWidth * SWIPE_THRESHOLD;
  return Math.abs(translateX) > threshold || Math.abs(velocity) > VELOCITY_THRESHOLD;
}
```

API Endpoints:
- GET /api/tasks?assignee={userId}&status={status}&sort={field}&order={asc|desc}&page={n}
- GET /api/tasks/{id}
- POST /api/tasks
- PUT /api/tasks/{id}
- DELETE /api/tasks/{id}
- POST /api/tasks/{id}/complete
- POST /api/tasks/{id}/uncomplete
- POST /api/tasks/bulk-complete (body: {taskIds: []})

Virtual List:
- Use react-window for lists >20 items
- Estimated row height: 72px
- Overscan: 5 items
- Dynamic height support for varying content

Animations:
- Completion: 200ms ease-out shrink + fade
- Undo toast: 300ms slide up
- Sheet open: 300ms ease-out slide up
- Sheet close: 200ms ease-in slide down

TESTING REQUIREMENTS:
Create tests in caskr.client/src/mobile/pages/MobileTasks/__tests__/:

LIST TESTS:
- TaskList renders tasks grouped by due date
- TaskList shows empty state when no tasks
- TaskList handles pagination on scroll
- TaskList shows loading indicator
- TaskList updates when filter changes

ITEM TESTS:
- TaskItem displays all task information
- TaskItem checkbox toggles completion
- TaskItem swipe right triggers complete
- TaskItem swipe left shows options menu
- TaskItem long press enters select mode
- TaskItem respects reduced motion preference
- TaskItem animates out on completion

DETAIL SHEET TESTS:
- TaskDetailSheet displays full task details
- TaskDetailSheet complete button works
- TaskDetailSheet edit button opens form
- TaskDetailSheet delete shows confirmation
- TaskDetailSheet closes on backdrop tap

FORM TESTS:
- TaskFormSheet validates required fields
- TaskFormSheet save button disabled when invalid
- TaskFormSheet saves task successfully
- TaskFormSheet shows error on API failure
- TaskFormSheet cancel with changes shows confirmation
- TaskFormSheet date picker works correctly
- TaskFormSheet assignee selector filters on search

FILTER TESTS:
- TaskFilters applies status filter
- TaskFilters applies priority filter
- TaskFilters applies due date filter
- TaskFilters applies order filter
- TaskFilters applies sort correctly
- TaskFilters clear resets all filters
- TaskFilters shows active filter count

MULTI-SELECT TESTS:
- Long press activates multi-select
- Tap selects/deselects in multi-select mode
- Select all works
- Bulk complete processes all selected
- Exit multi-select clears selection

STATE MANAGEMENT TESTS:
- useTasksState fetches tasks on mount
- useTasksState handles optimistic completion
- useTasksState rolls back on API failure
- useTasksState supports undo within window
- useTasksState queues offline completions
- useTasksState syncs when online

INTEGRATION TESTS:
- Full flow: view list -> swipe complete -> undo -> task restored
- Full flow: tap task -> view details -> edit -> save -> list updates
- Full flow: FAB -> create task -> save -> appears in list
- Offline flow: complete task offline -> toast shown -> sync when online

GESTURE TESTS:
- Swipe below threshold springs back
- Swipe above threshold triggers action
- Fast swipe triggers regardless of distance
- Swipe cancels if finger moves vertically

ACCESSIBILITY TESTS:
- All tasks are reachable via keyboard
- Screen reader announces task details
- Complete action is keyboard accessible
- Multi-select mode is accessible

PERFORMANCE TESTS:
- List with 100 tasks scrolls at 60fps
- Swipe animation runs at 60fps
- Completion animation runs at 60fps
- Initial render <500ms

DELIVERABLES:
1. All component files in MobileTasks folder
2. Reusable swipe gesture hook
3. Complete test suite
4. Offline support implementation
5. Integration with mobile router
6. Any API endpoint changes needed

Review the existing task management code and API endpoints, then create the mobile implementation."
"Feature","Progressive Web App (PWA) Support","Implement PWA capabilities for the mobile web app including offline support, app installation, push notifications, and background sync","New","1","8","mobile;pwa;offline","Mobile-Friendly Web Application (m.caskr.co)","- App can be installed on home screen (iOS and Android)
- Core pages work offline with cached data
- Changes made offline sync when connection restored
- Push notifications for assigned tasks and compliance alerts
- App loads instantly from cache on repeat visits
- Background sync processes queued operations",""
"Task","Implement Service Worker and Caching Strategy","Create a service worker with intelligent caching for offline support and instant loading","New","1","3","mobile;pwa;serviceworker","Progressive Web App (PWA) Support","","You are working on the Caskr distillery management application. Your task is to implement a service worker with a comprehensive caching strategy to enable offline functionality and instant loading for the mobile web application.

CONTEXT:
Caskr's mobile web app (m.caskr.co) needs to work reliably in warehouse environments where network connectivity may be spotty. Users need to be able to view cached barrel data, complete tasks, and record information even when offline, with automatic sync when connectivity returns.

REQUIREMENTS:

1. Service Worker Registration:
Create caskr.client/src/mobile/sw/register.ts:
- Register service worker on app load
- Handle registration errors gracefully
- Provide update notification when new version available
- Support manual update triggering
- Handle scope correctly for mobile subdomain

2. Service Worker Implementation:
Create caskr.client/public/mobile-sw.js (or use Workbox):
- Install event: Pre-cache critical assets
- Activate event: Clean up old caches
- Fetch event: Route requests through appropriate strategies
- Message event: Handle skip waiting and cache invalidation
- Sync event: Process background sync queue

3. Caching Strategies:
Implement different strategies for different resource types:

**App Shell (Cache First, Network Fallback):**
- HTML files
- JavaScript bundles
- CSS files
- Static images
- Fonts
Cache Name: caskr-app-shell-v{version}
Max Age: Until new deployment

**API Data (Network First, Cache Fallback):**
- GET /api/barrels/*
- GET /api/tasks/*
- GET /api/orders/*
- GET /api/dashboard/*
Cache Name: caskr-api-cache
Max Age: 24 hours
Max Items: 500

**User-Specific Data (Stale While Revalidate):**
- GET /api/tasks?assignee=me
- GET /api/dashboard/alerts
Cache Name: caskr-user-data
Max Age: 1 hour
Background Update: Yes

**Static Assets CDN (Cache First):**
- Images from CDN
- External fonts
Cache Name: caskr-cdn-cache
Max Age: 30 days

**Never Cache:**
- POST/PUT/DELETE requests (queue these instead)
- Authentication endpoints
- Real-time data (websocket)

4. Offline Data Storage:
Create caskr.client/src/mobile/sw/offlineStorage.ts:
- Use IndexedDB for structured offline data
- Store barrel details, tasks, orders for offline access
- Implement LRU eviction when storage limit approached
- Provide API for components to save/retrieve offline data

IndexedDB Schema:
```
caskr-offline-db
├── barrels (id, sku, data, cachedAt)
├── tasks (id, data, cachedAt)
├── orders (id, data, cachedAt)
├── pendingActions (id, type, payload, createdAt)
└── userPreferences (key, value)
```

5. Background Sync Queue:
Create caskr.client/src/mobile/sw/syncQueue.ts:
- Queue POST/PUT/DELETE requests when offline
- Store in IndexedDB with retry metadata
- Process queue when online (background sync event)
- Implement exponential backoff for failures
- Notify user of sync status
- Handle conflicts (server state changed)

Queue Item Schema:
```typescript
interface SyncQueueItem {
  id: string;
  url: string;
  method: 'POST' | 'PUT' | 'DELETE';
  body: string;
  headers: Record<string, string>;
  createdAt: number;
  retryCount: number;
  lastError?: string;
}
```

6. Cache Versioning and Updates:
- Version caches with deployment ID
- Delete old caches on activate
- Implement cache invalidation API
- Handle partial cache updates for large changes

7. Offline UI Indicators:
Create caskr.client/src/mobile/components/OfflineIndicator/OfflineIndicator.tsx:
- Show banner when offline
- Show pending sync count
- Show last sync time
- Allow manual sync trigger
- Animate during sync

TECHNICAL SPECIFICATIONS:

Workbox Configuration (if using Workbox):
```javascript
// workbox-config.js
module.exports = {
  globDirectory: 'build/',
  globPatterns: ['**/*.{html,js,css,png,svg,woff2}'],
  swDest: 'build/mobile-sw.js',
  runtimeCaching: [
    {
      urlPattern: /\/api\/barrels/,
      handler: 'NetworkFirst',
      options: {
        cacheName: 'caskr-api-cache',
        networkTimeoutSeconds: 5,
        expiration: {
          maxEntries: 500,
          maxAgeSeconds: 86400,
        },
      },
    },
    // ... more patterns
  ],
};
```

IndexedDB Wrapper:
- Use idb library for cleaner API
- Handle quota exceeded errors
- Implement storage estimation and cleanup

Background Sync Registration:
```javascript
// Register sync when action queued offline
async function queueAction(action: SyncQueueItem) {
  await db.add('pendingActions', action);
  if ('sync' in registration) {
    await registration.sync.register('sync-pending-actions');
  }
}
```

Conflict Resolution Strategy:
1. Server timestamp wins for data updates
2. User notified of conflicts
3. Option to retry with latest data
4. Never silently lose user data

TESTING REQUIREMENTS:
Create tests for service worker and offline functionality:

SERVICE WORKER TESTS (use MSW + Playwright):
- SW registers successfully
- SW caches app shell on install
- SW serves cached app shell when offline
- SW falls back to cache when network fails
- SW updates cache when new version deployed
- SW cleans up old caches on activate

CACHING STRATEGY TESTS:
- App shell resources served from cache (check headers)
- API requests go to network first
- API requests fall back to cache when offline
- Stale-while-revalidate updates cache in background
- Never-cache resources always go to network
- Cache respects max age settings
- Cache respects max items limit

INDEXEDDB TESTS:
- Data saves to IndexedDB correctly
- Data retrieves from IndexedDB correctly
- LRU eviction works when limit reached
- Handles quota exceeded error gracefully
- Schema migrations work correctly

SYNC QUEUE TESTS:
- Actions queue when offline
- Queue persists across page reloads
- Queue processes when back online
- Failed items retry with backoff
- Max retries prevents infinite loops
- Conflicts detected and handled
- User notified of sync results

OFFLINE INDICATOR TESTS:
- Shows when navigator.onLine is false
- Shows pending action count
- Updates when actions complete
- Manual sync button triggers sync
- Hides when back online and synced

INTEGRATION TESTS (Playwright):
- Full offline flow: go offline -> use app -> complete task -> go online -> task syncs
- App shell loads instantly from cache
- Stale data shown, then updates when fresh data arrives
- Update prompt shown when new SW version available

PERFORMANCE TESTS:
- Cache hit time <50ms
- IndexedDB read time <100ms
- Queue write time <50ms
- App shell served in <100ms from SW cache

DELIVERABLES:
1. Service worker implementation (Workbox or manual)
2. Registration and update handling code
3. IndexedDB wrapper with full schema
4. Background sync queue implementation
5. Offline indicator component
6. Complete test suite
7. Documentation for cache invalidation procedures

Study Workbox documentation and existing PWA best practices, then implement following the specifications above. Ensure all code includes proper error handling and logging."
"Task","Create Web App Manifest and Install Experience","Implement the web app manifest and add-to-home-screen experience for iOS and Android","New","1","2","mobile;pwa;manifest","Progressive Web App (PWA) Support","","You are working on the Caskr distillery management application. Your task is to create the web app manifest and implement the add-to-home-screen installation experience for the mobile web application.

CONTEXT:
A Progressive Web App needs a manifest file to be installable on users' devices. When installed, the app should look and feel like a native application - launching from the home screen, having its own icon, running in standalone mode without browser UI, and providing appropriate splash screens.

REQUIREMENTS:

1. Web App Manifest:
Create caskr.client/public/manifest.json:
```json
{
  ""name"": ""Caskr - Distillery Management"",
  ""short_name"": ""Caskr"",
  ""description"": ""Mobile distillery management for warehouse operations"",
  ""start_url"": ""/?source=pwa"",
  ""scope"": ""/"",
  ""display"": ""standalone"",
  ""orientation"": ""portrait-primary"",
  ""background_color"": ""#1a1a2e"",
  ""theme_color"": ""#4a90a4"",
  ""icons"": [...],
  ""screenshots"": [...],
  ""shortcuts"": [...],
  ""categories"": [""business"", ""productivity""],
  ""lang"": ""en-US"",
  ""dir"": ""ltr""
}
```

2. App Icons:
Create icons in caskr.client/public/icons/:
Required sizes (PNG, maskable where noted):
- icon-72x72.png
- icon-96x96.png
- icon-128x128.png
- icon-144x144.png
- icon-152x152.png
- icon-192x192.png (maskable version too)
- icon-384x384.png
- icon-512x512.png (maskable version too)
- apple-touch-icon.png (180x180)
- favicon.ico (multi-size: 16, 32, 48)
- favicon-16x16.png
- favicon-32x32.png

Icon design notes:
- Use Caskr brand colors
- Simple, recognizable at small sizes
- Maskable icons need safe zone (40% padding)
- Consistent across all sizes

3. Splash Screens:
Create splash screens for iOS (which doesn't auto-generate):
caskr.client/public/splash/:
- apple-splash-2048-2732.jpg (iPad Pro 12.9)
- apple-splash-1668-2388.jpg (iPad Pro 11)
- apple-splash-1536-2048.jpg (iPad)
- apple-splash-1242-2688.jpg (iPhone XS Max)
- apple-splash-1125-2436.jpg (iPhone X/XS)
- apple-splash-828-1792.jpg (iPhone XR)
- apple-splash-1242-2208.jpg (iPhone 8 Plus)
- apple-splash-750-1334.jpg (iPhone 8)

4. HTML Meta Tags:
Update caskr.client/index.html (or mobile entry point):
```html
<!-- PWA Meta Tags -->
<link rel=""manifest"" href=""/manifest.json"">
<meta name=""theme-color"" content=""#4a90a4"">
<meta name=""mobile-web-app-capable"" content=""yes"">
<meta name=""apple-mobile-web-app-capable"" content=""yes"">
<meta name=""apple-mobile-web-app-status-bar-style"" content=""black-translucent"">
<meta name=""apple-mobile-web-app-title"" content=""Caskr"">

<!-- Icons -->
<link rel=""icon"" type=""image/png"" sizes=""32x32"" href=""/icons/favicon-32x32.png"">
<link rel=""icon"" type=""image/png"" sizes=""16x16"" href=""/icons/favicon-16x16.png"">
<link rel=""apple-touch-icon"" href=""/icons/apple-touch-icon.png"">

<!-- iOS Splash Screens -->
<link rel=""apple-touch-startup-image"" href=""/splash/apple-splash-2048-2732.jpg"" media=""..."">
<!-- ... more splash screen links with media queries ... -->
```

5. Install Prompt Component:
Create caskr.client/src/mobile/components/InstallPrompt/InstallPrompt.tsx:
- Capture beforeinstallprompt event
- Show custom install prompt UI (don't use browser default)
- Track prompt state (shown, dismissed, installed)
- Respect user dismissal (don't show again for 7 days)
- Different UI for iOS (manual instructions) vs Android (direct install)

Component behavior:
- Show after user has engaged with app (e.g., completed 3 tasks)
- Show after 2 visits to the site
- Don't show if already installed
- Don't show on desktop
- Dismissible with ""Not now"" and ""Don't ask again""

6. Install Prompt UI:
Design an attractive, non-intrusive prompt:
```
┌─────────────────────────────────────────────┐
│  [Caskr Icon]                               │
│                                              │
│  Install Caskr                               │
│  Add to your home screen for quick access   │
│  and offline support.                        │
│                                              │
│  [Install Now]  [Not Now]                   │
│                                              │
│  ☐ Don't ask me again                       │
└─────────────────────────────────────────────┘
```

For iOS (no beforeinstallprompt):
```
┌─────────────────────────────────────────────┐
│  [Caskr Icon]                               │
│                                              │
│  Install Caskr                               │
│                                              │
│  1. Tap [Share Icon] at the bottom          │
│  2. Scroll and tap ""Add to Home Screen""    │
│  3. Tap ""Add""                              │
│                                              │
│  [Got it]                                   │
└─────────────────────────────────────────────┘
```

7. App Shortcuts (Manifest):
Add shortcuts for quick actions:
```json
""shortcuts"": [
  {
    ""name"": ""Scan Barrel"",
    ""short_name"": ""Scan"",
    ""description"": ""Scan a barrel barcode"",
    ""url"": ""/barrels?mode=scan"",
    ""icons"": [{""src"": ""/icons/shortcut-scan.png"", ""sizes"": ""96x96""}]
  },
  {
    ""name"": ""My Tasks"",
    ""short_name"": ""Tasks"",
    ""description"": ""View your assigned tasks"",
    ""url"": ""/tasks?filter=mine"",
    ""icons"": [{""src"": ""/icons/shortcut-tasks.png"", ""sizes"": ""96x96""}]
  }
]
```

8. Install Analytics:
Track installation funnel:
- beforeinstallprompt event fired
- Custom prompt shown
- Install button clicked
- appinstalled event fired
- Prompt dismissed
- ""Don't ask again"" selected

Create caskr.client/src/mobile/utils/installAnalytics.ts for tracking.

TECHNICAL SPECIFICATIONS:

Detecting Installed State:
```typescript
function isInstalledPWA(): boolean {
  // Check display-mode media query
  if (window.matchMedia('(display-mode: standalone)').matches) return true;
  // Check iOS standalone
  if ((navigator as any).standalone === true) return true;
  // Check URL parameter from start_url
  if (new URLSearchParams(window.location.search).has('source', 'pwa')) return true;
  return false;
}
```

beforeinstallprompt Handling:
```typescript
let deferredPrompt: BeforeInstallPromptEvent | null = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  // Show custom prompt when ready
});

async function installApp() {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  // Track outcome
  deferredPrompt = null;
}
```

TESTING REQUIREMENTS:
Create tests in caskr.client/src/mobile/components/InstallPrompt/__tests__/:

MANIFEST TESTS:
- Manifest file is valid JSON
- Manifest has all required fields
- All icon files exist and are valid images
- Icon sizes match manifest declarations
- Maskable icons have proper safe zone
- start_url is valid
- scope is correctly configured

INSTALL PROMPT TESTS:
- InstallPrompt captures beforeinstallprompt event
- InstallPrompt shows after engagement criteria met
- InstallPrompt doesn't show if already installed
- InstallPrompt doesn't show on desktop
- InstallPrompt shows iOS instructions on iOS
- Install button triggers prompt.prompt()
- Not Now button dismisses and sets timeout
- Don't ask again sets permanent dismissal
- Prompt state persists across sessions

ANALYTICS TESTS:
- Events tracked at each funnel stage
- Analytics handles missing gtag gracefully
- Analytics respects DNT header

VISUAL TESTS:
- Splash screens display correctly (Playwright screenshot)
- Icon displays correctly on home screen (manual test guide)
- App opens in standalone mode when installed

INTEGRATION TESTS (Playwright):
- Full install flow on Android Chrome
- Manual instructions display on iOS Safari
- App launches in standalone mode
- Shortcuts work when long-pressing icon (Android)

DELIVERABLES:
1. manifest.json with complete configuration
2. All icon files in required sizes
3. All splash screen files for iOS
4. Updated index.html with meta tags
5. InstallPrompt component with iOS/Android variants
6. Install analytics tracking
7. Complete test suite
8. Icon generation script (from source SVG)

Create high-quality icons using the Caskr brand. If you don't have access to design assets, create placeholder icons that demonstrate the correct structure and sizes, with notes on what the final designs should contain."
"Task","Implement Push Notifications","Set up push notification support for task assignments, compliance alerts, and sync status","New","1","3","mobile;pwa;notifications","Progressive Web App (PWA) Support","","You are working on the Caskr distillery management application. Your task is to implement push notification support for the mobile web application, enabling real-time alerts for task assignments, compliance deadlines, and sync status.

CONTEXT:
Warehouse staff need to be notified immediately when they're assigned new tasks or when compliance deadlines approach. Push notifications enable this even when the app isn't open. This requires both frontend (subscription management, notification display) and backend (subscription storage, sending) implementation.

REQUIREMENTS:

1. Backend - Push Subscription Management:
Create Caskr.Server/Services/PushNotificationService.cs:
- Store push subscriptions in database
- Associate subscriptions with users
- Support multiple subscriptions per user (different devices)
- Implement subscription validation (check if still valid)
- Clean up expired/invalid subscriptions

Create Caskr.Server/Models/PushSubscription.cs:
```csharp
public class PushSubscription
{
    public long Id { get; set; }
    public int UserId { get; set; }
    public string Endpoint { get; set; }
    public string P256dhKey { get; set; }
    public string AuthKey { get; set; }
    public string UserAgent { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? LastUsedAt { get; set; }
    public bool IsActive { get; set; }
}
```

2. Backend - Push Sending Service:
Create Caskr.Server/Services/PushSenderService.cs:
- Use WebPush library (web-push-csharp or similar)
- Queue notifications for background processing
- Handle subscription expiration (410 Gone response)
- Implement retry logic for transient failures
- Support notification payloads with actions

Notification Payload Schema:
```json
{
  ""title"": ""New Task Assigned"",
  ""body"": ""Move barrel BAR-001 to Rickhouse B"",
  ""icon"": ""/icons/icon-192x192.png"",
  ""badge"": ""/icons/badge-72x72.png"",
  ""tag"": ""task-123"",
  ""data"": {
    ""type"": ""task_assigned"",
    ""taskId"": 123,
    ""url"": ""/tasks/123""
  },
  ""actions"": [
    {""action"": ""view"", ""title"": ""View Task""},
    {""action"": ""complete"", ""title"": ""Mark Complete""}
  ]
}
```

3. Backend - Notification Triggers:
Integrate push sending into existing services:

TasksService.cs - Send notification when:
- Task assigned to user
- Task due date approaching (1 hour, 1 day)
- Task marked urgent

TtbComplianceService.cs - Send notification when:
- Monthly report due in 3 days
- Monthly report due tomorrow
- Report requires approval (to approvers)
- Report approved/rejected

SyncService.cs - Send notification when:
- Offline queue sync completed
- Sync failed and needs attention

4. Backend API Endpoints:
Create Caskr.Server/Controllers/PushController.cs:
- POST /api/push/subscribe - Save new subscription
- DELETE /api/push/subscribe - Remove subscription
- GET /api/push/subscriptions - List user's subscriptions
- POST /api/push/test - Send test notification (dev only)

5. Backend - VAPID Configuration:
Add to appsettings.json:
```json
{
  ""PushNotifications"": {
    ""VapidSubject"": ""mailto:support@caskr.co"",
    ""VapidPublicKey"": ""<generate>"",
    ""VapidPrivateKey"": ""<generate>""
  }
}
```

Create key generation script: scripts/generate-vapid-keys.js

6. Frontend - Subscription Management:
Create caskr.client/src/mobile/services/pushSubscription.ts:
- Check notification permission status
- Request notification permission
- Subscribe to push manager
- Send subscription to backend
- Handle subscription changes
- Unsubscribe and notify backend

7. Frontend - Service Worker Push Handler:
Add to mobile-sw.js:
```javascript
self.addEventListener('push', event => {
  const data = event.data?.json() ?? {};
  event.waitUntil(
    self.registration.showNotification(data.title, {
      body: data.body,
      icon: data.icon,
      badge: data.badge,
      tag: data.tag,
      data: data.data,
      actions: data.actions,
      vibrate: [200, 100, 200],
      requireInteraction: data.data?.type === 'compliance_alert'
    })
  );
});

self.addEventListener('notificationclick', event => {
  event.notification.close();
  const url = event.notification.data?.url ?? '/';
  const action = event.action;

  if (action === 'complete') {
    // Handle quick action
    event.waitUntil(handleQuickComplete(event.notification.data));
  } else {
    // Navigate to URL
    event.waitUntil(clients.openWindow(url));
  }
});
```

8. Frontend - Notification Preferences UI:
Create caskr.client/src/mobile/pages/Settings/NotificationSettings.tsx:
- Master enable/disable toggle
- Per-category toggles:
  - Task assignments
  - Task reminders (due soon)
  - Compliance alerts
  - Sync status
- Quiet hours setting
- Test notification button

9. Frontend - Permission Request UI:
Create caskr.client/src/mobile/components/NotificationPermission/NotificationPermission.tsx:
- Explain value of notifications before requesting
- Show only when relevant (e.g., after first task assigned)
- Handle all permission states: default, granted, denied
- Provide guidance if permission denied (link to settings)

TECHNICAL SPECIFICATIONS:

VAPID Key Generation:
```javascript
const webpush = require('web-push');
const vapidKeys = webpush.generateVAPIDKeys();
console.log('Public:', vapidKeys.publicKey);
console.log('Private:', vapidKeys.privateKey);
```

Subscription Object (from PushManager):
```typescript
interface PushSubscriptionJSON {
  endpoint: string;
  keys: {
    p256dh: string;
    auth: string;
  };
}
```

Web Push Library (C#):
Use WebPush package: `dotnet add package WebPush`

Notification Display Constraints:
- Title: max 50 characters (truncated on some platforms)
- Body: max 120 characters (truncated on some platforms)
- Icon: 192x192 recommended
- Badge: 72x72 monochrome for Android

Quiet Hours Logic:
- Store user's timezone
- Check local time before sending
- Queue notifications during quiet hours for morning delivery

TESTING REQUIREMENTS:

BACKEND TESTS:
Create Caskr.Server.Tests/Services/PushNotificationServiceTests.cs:

Subscription tests:
- SaveSubscription creates new subscription
- SaveSubscription updates existing subscription for same endpoint
- GetSubscriptions returns user's subscriptions
- DeleteSubscription removes subscription
- CleanupInvalidSubscriptions removes expired subscriptions

Sending tests:
- SendNotification delivers to valid subscription
- SendNotification handles 410 Gone (removes subscription)
- SendNotification retries on 5xx errors
- SendNotification respects quiet hours
- SendNotification queues for background processing

Trigger tests:
- Task assignment triggers notification to assignee
- Task due soon triggers reminder notification
- Compliance deadline triggers alert notification
- Sync complete triggers status notification

API tests:
- POST /api/push/subscribe creates subscription
- POST /api/push/subscribe requires authentication
- DELETE /api/push/subscribe removes subscription
- GET /api/push/subscriptions returns only user's subscriptions

FRONTEND TESTS:
Create caskr.client/src/mobile/services/__tests__/pushSubscription.test.ts:

Permission tests:
- checkPermission returns correct status
- requestPermission shows browser prompt
- requestPermission handles denial gracefully

Subscription tests:
- subscribe creates PushManager subscription
- subscribe sends subscription to backend
- unsubscribe removes subscription
- unsubscribe notifies backend

Service Worker tests (Playwright):
- Push event shows notification
- Notification click opens correct URL
- Notification action triggers quick complete
- Multiple notifications with same tag replace

Settings tests:
- Toggle enables/disables notifications
- Category toggles update preferences
- Quiet hours saves correctly
- Test button sends test notification

INTEGRATION TESTS:
- Full flow: task assigned -> notification sent -> received -> clicked -> app opens to task
- Permission flow: first relevant action -> permission prompt -> granted -> subscribed
- Offline flow: notification received while offline -> clicked when online -> correct page

DELIVERABLES:
1. PushNotificationService.cs
2. PushSenderService.cs
3. PushSubscription.cs model and migration
4. PushController.cs API endpoints
5. Configuration for VAPID keys
6. Frontend subscription management
7. Service worker push/click handlers
8. Notification settings page
9. Permission request component
10. VAPID key generation script
11. Complete test suite
12. Documentation for notification payload formats

Research web push best practices and the WebPush library before implementing. Ensure notifications work on both iOS (with limitations) and Android."
